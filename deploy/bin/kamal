#!/bin/bash

# Kamal wrapper script that handles macOS and Linux differences
# Usage: ./bin/kamal [commands]

set -e

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEPLOY_DIR="$(dirname "$SCRIPT_DIR")"

# Change to deploy directory
cd "$DEPLOY_DIR"

# Check if --version flag is already provided
HAS_VERSION_FLAG=false
for arg in "$@"; do
    if [[ "$arg" == "--version" ]] || [[ "$arg" == "-v" ]]; then
        HAS_VERSION_FLAG=true
        break
    fi
done

# If no --version flag and no VERSION env var, add --version flag
EXTRA_ARGS=""
if [[ "$HAS_VERSION_FLAG" == "false" ]] && [[ -z "$VERSION" ]]; then
    EXTRA_ARGS="--version latest"
fi

# Detect OS
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    docker run -it --rm \
        -v "${PWD}:/workdir" \
        -v "/run/host-services/ssh-auth.sock:/run/host-services/ssh-auth.sock" \
        -e SSH_AUTH_SOCK="/run/host-services/ssh-auth.sock" \
        -e VERSION="${VERSION}" \
        -v /var/run/docker.sock:/var/run/docker.sock \
        ghcr.io/basecamp/kamal:latest $EXTRA_ARGS "$@"
else
    # Linux
    docker run -it --rm \
        -v "${PWD}:/workdir" \
        -v "${SSH_AUTH_SOCK}:/ssh-agent" \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -e "SSH_AUTH_SOCK=/ssh-agent" \
        -e VERSION="${VERSION}" \
        ghcr.io/basecamp/kamal:latest $EXTRA_ARGS "$@"
fi